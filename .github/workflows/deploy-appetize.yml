name: Deploy to Appetize

on:
  push:
    branches: [ main ]
    paths:
      - 'mobile/**'

jobs:
  deploy-appetize:
    name: Build and Deploy to Appetize.io
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
      
      - name: ðŸ”§ Create config.dart
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          cat > mobile/lib/config.dart << EOF
          import 'dart:io';

          class AppConfig {
            static const String googleMapsApiKey = '$GOOGLE_MAPS_API_KEY';
            static const String backendUrl = '$BACKEND_URL';
          }
          EOF

      - name: ðŸ”§ Create google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > mobile/android/app/google-services.json
      
      - name: ðŸ“¦ Install dependencies
        run: |
          cd mobile
          flutter pub get
      
      - name: ðŸ”¨ Build APK
        run: |
          cd mobile
          flutter build apk --release
      
      - name: ðŸ“¤ Upload to Appetize.io
        env:
          APPETIZE_TOKEN: ${{ secrets.APPETIZE_API_TOKEN }}
          APPETIZE_KEY: ${{ secrets.APPETIZE_PUBLIC_KEY }}
        run: |
          curl -X POST https://api.appetize.io/v1/apps/$APPETIZE_KEY \
            -F file=@mobile/build/app/outputs/flutter-apk/app-release.apk \
            -u $APPETIZE_TOKEN:
      
      - name: âœ… Success
        run: |
          echo "ðŸŽ‰ APK successfully uploaded to Appetize!"
          echo "ðŸ“± Your app is live at: https://appetize.io/app/${{ secrets.APPETIZE_PUBLIC_KEY }}"